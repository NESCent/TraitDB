<div class="row-fluid">
  <div class="offset1 span10">
    <div class="row-fluid">&nbsp;</div>
    <div class="row-fluid">
      <div class="pull-left">
        <p class="lead">Search Results: (<%= pluralize(@results[:otus].count, 'row')%>)</p>
      </div>
      <div class="btn-group pull-right">
        <%= link_to(raw('<i class="icon-bookmark"></i> Link to this Search'), params_for_search(params), :class => 'btn btn-small') %>
        <%= link_to(raw('<i class="icon-download-alt icon-white"></i> Download Results (CSV)'), params_for_search(params).merge({:format => :csv}), :class => 'btn btn-small btn-primary') %>
      </div>
    </div>
    <div class="row-fluid">&nbsp;</div>
    <div class="row-fluid">
      <table class="table table-condensed table-bordered table-striped table-hover ">
        <tr>
          <th>Higher Group</th>
          <th>Order</th>
          <th>Family</th>
          <th>Genus</th>
          <th>Species</th>
          <% @results[:categorical_traits].each do |trait| %>
            <th><%= trait.name %></th>
            <% if @results[:include_references] %>
              <th>Source:<%= trait.name %></th>
            <% end %>
          <% end %>
          <% @results[:continuous_traits].each do |trait| %>
            <th><%= trait.name %></th>
            <% if @results[:include_references] %>
              <th>Source:<%= trait.name %></th>
            <% end %>
          <% end %>
          <th>Notes</th>
        </tr>
        <% @results[:otus].each do |otu| %>
        <tr>
          <td><%= otu.htg_name %></td>
          <td><%= otu.order_name %></td>
          <td><%= otu.family_name %></td>
          <td><%= otu.genus_name %></td>
          <td><%= otu.species_name %></td>
            <% @results[:categorical_traits].each do |trait|
               categorical_trait_values = otu.categorical_trait_values.where(:categorical_trait_id => trait.id) %>
              <td>
                <%= categorical_trait_values.map{|c| c.categorical_trait_category.name}.join(', ') %>
              </td>
              <% if @results[:include_references] %>
                <td>
                  <% if categorical_trait_values.first %>
                    <span class="source_popover" rel="popover" data-content="<%= categorical_trait_values.first.source_reference %>" data-original-title="Source">
                      <%= truncate(categorical_trait_values.first.source_reference.to_s) %>
                    </span>
                  <% end %>
              </td>
            <% end %>
          <% end %>
          <% @results[:continuous_traits].each do |trait|
               # This should not be done in the view
               continuous_value = otu.continuous_trait_values.find_by_continuous_trait_id(trait.id) %>
            <td>
              <% if continuous_value %>
                <%= continuous_value.value %>
              <% end %>
            </td>
            <% if @results[:include_references] %>
              <td>
                <% if continuous_value %>
                  <span class="source_popover" rel="popover" data-content="<%= continuous_value.source_reference %>" data-original-title="Source">
                    <%= truncate(continuous_value.source_reference.to_s) %>
                  </span>
                <% end %>
              </td>
            <% end %>
          <% end %>
          <td><span class="notes_popover" rel="popover" data-content="<%= otu.notes %>" data-original-title="Notes">
            <%= truncate(otu.notes) %>
          </span></td>
        </tr>
        <% end %>
      </table>
    </div>
   </div>
</div>
<script type="text/javascript">
  $(document).ready(function() {
    $('.notes_popover, .source_popover').popover({trigger: 'hover', html: true, placement: 'bottom', delay: {hide: 100} });
  });
</script>
