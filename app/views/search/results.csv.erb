<%-
  headers = ['Higher Taxonomic Group','Order','Family','Genus','Species']
  @results[:columns][:categorical_traits].each do |trait|
    headers << trait[:name]
    if @results[:columns][:categorical_trait_notes_ids].include? trait[:id]
      headers << "Notes: #{trait[:name]}"
    end
    if @results[:include_references]
      headers << "Source: #{trait[:name]}"
    end
  end
  @results[:columns][:continuous_traits].each do |trait|
    headers << trait[:name]
    if @results[:columns][:continuous_trait_notes_ids].include? trait[:id]
      headers << "Notes: #{trait[:name]}"
    end
    if @results[:include_references]
      headers << "Source: #{trait[:name]}"
    end
  end
  headers << 'Notes'
-%>
<%= CSV.generate_line headers -%>
<%-
    @results[:rows].each do |data_row|
      otu = data_row[:otu]
      row = []
      row << otu.htg_name
      row << otu.order_name
      row << otu.family_name
      row << otu.genus_name
      row << otu.species_name
      @results[:columns][:categorical_traits].each do |trait|
        categorical_trait_values = data_row[:categorical_trait_values].find{|v| v[:categorical_trait_id] == trait[:id] }
        if categorical_trait_values.nil?
          row << nil
          row << nil if @results[:columns][:categorical_trait_notes_ids].include? trait[:id]
          row << nil if @results[:include_references]
        else
          row << categorical_trait_values[:values].join('|')
          row << categorical_trait_values[:notes] if @results[:columns][:categorical_trait_notes_ids].include? trait[:id]
          row << categorical_trait_values[:sources].first if @results[:include_references]
        end
      end
      @results[:columns][:continuous_traits].each do |trait|
        continuous_trait_values = data_row[:continuous_trait_values].find{|v| v[:continuous_trait_id] == trait[:id] }
        if continuous_trait_values.nil?
          row << nil
          row << nil if @results[:columns][:continuous_trait_notes_ids].include? trait[:id]
          row << nil if @results[:include_references]
        else
          row << continuous_trait_values[:values].join('|')
          row << continuous_trait_values[:notes] if @results[:columns][:continuous_trait_notes_ids].include? trait[:id]
          row << continuous_trait_values[:sources].first if @results[:include_references]
        end
      end
      row << otu.notes.to_s
-%>
<%= CSV.generate_line(row).html_safe -%>
<%- end -%>