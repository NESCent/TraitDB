<%-
  headers = ['Higher Taxonomic Group','Order','Family','Genus','Species']
  @results[:categorical_traits].each do |trait|
    headers << trait.name
    if @results[:include_references]
      headers << "Source: #{trait.name}"
    end
  end
  @results[:continuous_traits].each do |trait|
    headers << trait.name
    if @results[:include_references]
      headers << "Source: #{trait.name}"
    end
  end
  headers << 'Notes'
-%>
<%= CSV.generate_line headers -%>
<%-
    @results[:otus].each do |otu|
      row = []
      row << otu.htg_name
      row << otu.order_name
      row << otu.family_name
      row << otu.genus_name
      row << otu.species_name
      @results[:categorical_traits].each do |trait|
        categorical_trait_values = otu.categorical_trait_values.where(:categorical_trait_id => trait.id)
        if categorical_trait_values.empty?
          row << nil
          row << nil if @results[:include_references]
        else
          row << categorical_trait_values.map{|c| c.categorical_trait_category.name}.join('|')
          row << categorical_trait_values.first.source_reference.to_s if @results[:include_references]
        end
      end
      @results[:continuous_traits].each do |trait|
        continuous_value = otu.continuous_trait_values.find_by_continuous_trait_id(trait.id)
        if continuous_value
          row << continuous_value.value
          if @results[:include_references]
            row << continuous_value.source_reference.to_s
          end
        else
          row << nil
          if @results[:include_references]
            row << nil
          end
        end
      end
      row << otu.notes.to_s
-%>
<%= CSV.generate_line(row).html_safe -%>
<%- end -%>