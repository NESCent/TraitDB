<%-
  headers = @results[:columns][:iczn_groups].map{|group| group[:name]}
  @results[:columns][:categorical_traits].each do |trait|
    headers << trait[:name]
    if @results[:columns][:categorical_trait_notes_ids].include? trait[:id]
      headers << "Notes: #{trait[:name]}"
    end
    if @results[:include_references]
      headers << "Source: #{trait[:name]}"
    end
  end
  @results[:columns][:continuous_traits].each do |trait|
    headers << trait[:name]
    if @results[:columns][:continuous_trait_notes_ids].include? trait[:id]
      headers << "Notes: #{trait[:name]}"
    end
    if @results[:include_references]
      headers << "Source: #{trait[:name]}"
    end
  end
  @results[:columns][:otu_metadata_field_names].each do |metadata_field|
    headers << metadata_field
  end
-%>
<%= CSV.generate_line headers -%>
<%-
    @results[:rows].each do |data_row|
      row = []
      @results[:columns][:iczn_groups].each do |group|
        row << data_row[:taxonomy][group[:id]]
      end
      @results[:columns][:categorical_traits].each do |trait|
        categorical_trait_values = data_row[:categorical_trait_values].find{|v| v[:categorical_trait_id] == trait[:id] }
        if categorical_trait_values.nil?
          row << nil
          row << nil if @results[:columns][:categorical_trait_notes_ids].include? trait[:id]
          row << nil if @results[:include_references]
        else
          row << categorical_trait_values[:values].join('|')
          row << categorical_trait_values[:notes] if @results[:columns][:categorical_trait_notes_ids].include? trait[:id]
          row << categorical_trait_values[:sources].first if @results[:include_references]
        end
      end
      @results[:columns][:continuous_traits].each do |trait|
        continuous_trait_values = data_row[:continuous_trait_values].find{|v| v[:continuous_trait_id] == trait[:id] }
        if continuous_trait_values.nil?
          row << nil
          row << nil if @results[:columns][:continuous_trait_notes_ids].include? trait[:id]
          row << nil if @results[:include_references]
        else
          row << continuous_trait_values[:values].join('|')
          row << continuous_trait_values[:notes] if @results[:columns][:continuous_trait_notes_ids].include? trait[:id]
          row << continuous_trait_values[:sources].first if @results[:include_references]
        end
      end
      @results[:columns][:otu_metadata_field_names].each do |metadata_field_name|
        row << data_row[:metadata][metadata_field_name]
      end
-%>
<%= CSV.generate_line(row).html_safe -%>
<%- end -%>